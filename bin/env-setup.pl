#!/usr/bin/env perl
use FindBin;
use Mojo::Base -strict;
use Mojo::File 'path';
use File::Copy 'copy';
use autodie;

# use lib "$FindBin::Bin/../lib";

=head1 NAME

env-setup.pl

=head1 DESCRIPTION

Set up environment


=cut


sub link_file {
	my ($file, $link) = @_;
	if (-l $link) {
		return;
	}
	if ( -f $link ) {
		copy($file, $link) or die "Cant copy($file, $link): $!";
		return;
	}
	warn "link , $file, $link";
	my $return = link $file, $link;
	if (! $return ) {
	 	my $err = $!;
	 	if ($err =~ m/Invalid cross-device link/) {
			 copy( $file, $link ) or die "Cant copy($file, $link): $!";
	 	} else {
			die "Cant make link $link $!"
		}
	}
}

my $gitdir = "$FindBin::Bin/../../";
my $microdir = "$ENV{HOME}/.config/micro";
my $repocnfdir = "$FindBin::Bin/../config";

# SET UP MICRO
if ( -d $microdir ) {
	my $settingfile = "$microdir/settings.json";
	link_file( "$repocnfdir/micro/settings.json", $settingfile );
	my $syntaxdir = "$ENV{HOME}/.config/micro/syntax";
	if ( ! -d $syntaxdir ) {
		warn "mkdir $syntaxdir";
		mkdir $syntaxdir;
	}
	my $linkperlyaml = "$syntaxdir/perl.yaml";
	if (! -f $linkperlyaml) {
		my $repofile = "$gitdir/my-linux-configuration/config/micro/syntax/perl.yaml";
		link_file($repofile, $linkperlyaml);
	}
}

# SET UP .bashrc
my $bashrc = path($ENV{HOME}, '.bashrc');
if (-f $bashrc) {
  my $extra_file =  $ENV{ HOME } ."/git/my-linux-configuration/my-bash-extra.sh";
	if ( $bashrc->slurp !~/\/my-linux-configuration\/my\-bash-extra\.sh/){
		$bashrc->spurt($bashrc->slurp , "\nsource $extra_file\n");
		warn "Added source $extra_file .bashrc";
	}

  if ( $bashrc->slurp !~ /[^i][^o].\/my\-bashrc-extra\.sh/){
  	$bashrc->spurt($bashrc->slurp , "\nsource " . $ENV{ HOME } ."/my-bashrc-extra.sh\n");
  	warn 'Added . ~/my-bashrc-extra.sh to .bashrc';
  }
} else {
	warn ".bashrc not found";
}

my $content= <<"EOF";
# GENERATED BY $0
# DO NOT MODIFY. MODIFY SCRIPT ABOVE INSTEAD OR RERUN IT.

EOF
$content .= 'export PATH=$PATH';
my $git = path($ENV{HOME}.'/git');
for my $gt ($git->list({dir=>1})->each) {
	next if(-f $gt);
	my $bin = path($gt)->child('bin');
	if (-d $bin) {
		$content.=":$bin";
	}

}
$content .="\n";
my $be = path($ENV{HOME},'my-bashrc-extra.sh');
$be->spurt($content);
chmod (0700,$be);

# COPY SERTANT FILES
# path("$FindBin::Bin/m")->copy_to("$ENV{HOME}/bin/m");